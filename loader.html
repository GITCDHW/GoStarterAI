<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Infinite Driving Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            color: #ecf0f1;
            overflow: hidden;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 100%;
            max-height: 800px;
            background-color: #34495e;
            border: 5px solid #2980b9;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            width: 100%;
            height: 100%;
            background-color: #7f8c8d;
            display: block;
        }

        #game-ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background-color: rgba(44, 62, 80, 0.8);
            padding: 20px;
            border-radius: 10px;
        }

        #score-display {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        #start-button {
            padding: 15px 30px;
            font-size: 1.5em;
            font-weight: bold;
            color: #ecf0f1;
            background-color: #27ae60;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #start-button:hover {
            background-color: #2ecc71;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div id="game-ui">
            <h1 id="score-display">Score: 0</h1>
            <h2>Play A Game While Our AI Builds Your Business</h2>
            <button id="start-button">Start Game</button>
        </div>
    </div>
    <script>
        // Game variables
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('start-button');
        const scoreDisplay = document.getElementById('score-display');

        // Adjust canvas dimensions for responsiveness
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Game state
        let gameRunning = false;
        let score = 0;
        let lastTimestamp = 0;
        let carSpeed = 6;
        let obstacleSpeed = 5;
        let lastObstacleLanes = []; // This variable was missing in your code

        // Player car properties
        let car = {
            x: canvas.width / 2,
            y: canvas.height - 100,
            width: 40,
            height: 70,
            lane: 1, // 0: left, 1: center, 2: right
        };

        // Road properties
        const roadWidth = canvas.width * 0.7;
        const laneWidth = roadWidth / 3;
        const road = {
            x: (canvas.width - roadWidth) / 2,
            y: 0,
            width: roadWidth,
            height: canvas.height,
        };

        // Obstacle properties
        let obstacles = [];
        let lastObstacleTime = 0;
        const obstacleInterval = 3000;
        const minObstacleSpeed = 2;
        const maxObstacleSpeed = 5;

        // Touch controls
        let touchStartX = 0;

        function handleTouchStart(e) {
            e.preventDefault();
            if (!gameRunning) return;
            touchStartX = e.touches[0].clientX;
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!gameRunning) return;
            const touchMoveX = e.touches[0].clientX;
            const swipeDelta = touchMoveX - touchStartX;

            // Change lane based on swipe direction
            if (swipeDelta > 50 && car.lane < 2) {
                car.lane++;
                touchStartX = touchMoveX;
            } else if (swipeDelta < -50 && car.lane > 0) {
                car.lane--;
                touchStartX = touchMoveX;
            }
        }

        function updateCarPosition() {
            const targetX = road.x + (car.lane * laneWidth) + (laneWidth / 2) - (car.width / 2);
            // Smoothly move the car to the center of the current lane
            car.x += (targetX - car.x) * 0.08;
        }

        // Drawing functions
        function drawRoad() {
            ctx.fillStyle = '#6c7a89';
            ctx.fillRect(road.x, road.y, road.width, road.height);

            // Draw dashed lane lines
            ctx.strokeStyle = '#ecf0f1';
            ctx.lineWidth = 5;
            ctx.setLineDash([20, 20]);

            ctx.beginPath();
            ctx.moveTo(road.x + laneWidth, 0);
            ctx.lineTo(road.x + laneWidth, canvas.height);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(road.x + 2 * laneWidth, 0);
            ctx.lineTo(road.x + 2 * laneWidth, canvas.height);
            ctx.stroke();

            ctx.setLineDash([]); // Reset line dash
        }

        function drawCar() {
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(car.x, car.y, car.width, car.height);
            ctx.fillStyle = '#c0392b';
            ctx.fillRect(car.x, car.y + car.height * 0.2, car.width, car.height * 0.6); // Hood and roof detail
        }

        // Renamed function to createObstacle() from drawObstacle()
        function createObstacle() {
            let availableLanes = [0, 1, 2];

            // Filter out lanes blocked by the last two obstacles to ensure a clear path
            if (lastObstacleLanes.length >= 2) {
                let lastLane1 = lastObstacleLanes[0];
                let lastLane2 = lastObstacleLanes[1];
                availableLanes = availableLanes.filter(lane => lane !== lastLane1 && lane !== lastLane2);
            }

            let laneToSpawn;
            if (availableLanes.length > 0) {
                laneToSpawn = availableLanes[Math.floor(Math.random() * availableLanes.length)];
            } else {
                laneToSpawn = Math.floor(Math.random() * 3);
            }

            const x = road.x + (laneToSpawn * laneWidth) + (laneWidth / 2) - (car.width / 2);
            const y = -100;
            const speed = minObstacleSpeed + Math.random() * (maxObstacleSpeed - minObstacleSpeed);

            obstacles.push({
                x: x,
                y: y,
                width: 40,
                height: 70,
                speed: speed,
            });

            // Update the list of last obstacle lanes
            lastObstacleLanes.push(laneToSpawn);
            if (lastObstacleLanes.length > 2) {
                lastObstacleLanes.shift(); // Keep the array to a maximum of 2 lanes
            }
        }
        
        // This function was missing from your update
        function drawObstacles() {
            ctx.fillStyle = '#f1c40f';
            obstacles.forEach(obstacle => {
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });
        }

        function updateGame(timestamp) {
            if (!gameRunning) return;

            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Update and draw road
            drawRoad();

            // Update car position
            updateCarPosition();
            drawCar();

            // Spawn new obstacles
            if (timestamp - lastObstacleTime > obstacleInterval / (carSpeed * 0.5)) {
                createObstacle(); // Corrected function call
                lastObstacleTime = timestamp;
            }

            // Update and draw obstacles
            obstacles.forEach(obstacle => {
                obstacle.y += obstacle.speed;
            });
            drawObstacles();

            // Check for collisions
            obstacles.forEach(obstacle => {
                if (
                    car.x < obstacle.x + obstacle.width &&
                    car.x + car.width > obstacle.x &&
                    car.y < obstacle.y + obstacle.height &&
                    car.y + car.height > obstacle.y
                ) {
                    endGame();
                }
            });

            // Remove off-screen obstacles and update score
            obstacles = obstacles.filter(obstacle => obstacle.y < canvas.height);
            score += obstacles.length * 0.01;
            scoreDisplay.textContent = `Score: ${Math.floor(score)}`;

            // Increase speed over time
            carSpeed += 0.001;
            obstacleSpeed += 0.001;

            requestAnimationFrame(updateGame);
        }

        function startGame() {
            gameRunning = true;
            score = 0;
            obstacles = [];
            lastObstacleLanes = []; // Reset the lanes on a new game
            carSpeed = 5;
            obstacleSpeed = 10;
            car.lane = 1;
            car.x = (canvas.width / 2) - (car.width / 2);

            startButton.style.display = 'none';
            scoreDisplay.style.display = 'block';

            // Add touch event listeners for mobile controls
            canvas.addEventListener('touchstart', handleTouchStart, false);
            canvas.addEventListener('touchmove', handleTouchMove, false);

            requestAnimationFrame(updateGame);
        }

        function endGame() {
            gameRunning = false;
            startButton.textContent = 'Play Again';
            startButton.style.display = 'block';
            scoreDisplay.textContent = `Final Score: ${Math.floor(score)}`;

            // Remove touch event listeners
            canvas.removeEventListener('touchstart', handleTouchStart);
            canvas.removeEventListener('touchmove', handleTouchMove);
        }

        startButton.addEventListener('click', startGame);

        // Initial state
        drawRoad();
        drawCar();
    </script>
</body>
</html>
