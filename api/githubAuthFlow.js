import axios from 'axios';
import { Response } from '@vercel/node'; // It's a good practice to import Response for clarity

/**
 * A utility function to make a request to GitHub to create a new repository.
 * @param {string} accessToken - The GitHub access token for the authenticated user.
 * @param {string} repoName - The name of the new repository.
 * @returns {Promise<object>} An object containing the success status and the new repo's URL or an error message.
 */
const createNewRepo = async (accessToken, repoName) => {
    try {
        const apiUrl = 'https://api.github.com/user/repos';
        const requestBody = {
            name: repoName,
            private: false,
            description: 'This business website was automatically generated by GoStarterAI - your all-in-one business launchpad!',
        };
        const requestHeaders = {
            'Authorization': `token ${accessToken}`,
            'Content-Type': 'application/json',
        };

        const response = await axios.post(apiUrl, requestBody, { headers: requestHeaders });

        if (response.status === 201) {
            console.log(`Repository '${repoName}' created successfully.`);
            return {
                success: true,
                html_url: response.data.html_url,
                full_name: response.data.full_name,
            };
        } else {
            console.error(`Error creating repository. Status code: ${response.status}`);
            return { success: false, error: 'Unexpected status code from GitHub API.' };
        }
    } catch (error) {
        console.error('Error creating new repository:', error.response?.data?.message || error.message);
        return { success: false, error: error.response?.data?.message || 'An unknown error occurred.' };
    }
};

// Main handler for the Cloud Function.
export default async function handler(event) {
    // Extract the authorization code and state from the query parameters.
    const tempCode = event.queryStringParameters?.code;
    const id = event.queryStringParameters?.id;

    // If no authorization code is present, it's a direct visit or an error from GitHub.
    if (!tempCode) {
        const githubAuthUrl = `https://github.com/login/oauth/authorize?client_id=${process.env.GITHUB_CLIENT_ID}&redirect_uri=https://go-starter-ai.vercel.app/api/githubAuthFlow&scope=repo,user:email&id=${id}`;
        return Response.redirect(githubAuthUrl, 302);
    }

    try {
        const response = await axios.post(
            'https://github.com/login/oauth/access_token',
            {
                client_id: process.env.GITHUB_CLIENT_ID,
                client_secret: process.env.GITHUB_CLIENT_SECRET,
                code: tempCode,
                redirect_uri: 'https://go-starter-ai.vercel.app/api/githubAuthFlow',
            },
            {
                headers: { 'Accept': 'application/json' },
            },
        );

        const { access_token: accessToken } = response.data;

        if (!accessToken) {
            const redirectUrl = 'https://go-starter-ai.vercel.app/error.html?reason=access_token_missing';
            return Response.redirect(redirectUrl, 302);
        }

        // Use the access token to create a new repository.
        const repoResult = await createNewRepo(accessToken, 'TEST-REPO-GOSTARTER-AI');

        if (repoResult.success) {
            const redirectUrl = `https://go-starter-ai.vercel.app/dashboard.html?id=${id}&repo=${encodeURIComponent(repoResult.full_name)}`;
            return Response.redirect(redirectUrl, 302);
        } else {
            const redirectUrl = `https://go-starter-ai.vercel.app/error.html?reason=repo_creation_failed&details=${encodeURIComponent(repoResult.error)}`;
            return Response.redirect(redirectUrl, 302);
        }
    } catch (error) {
        console.error('Error during authentication flow:', error);
        const redirectUrl = 'https://go-starter-ai.vercel.app/error.html?reason=internal_server_error';
        return Response.redirect(redirectUrl, 302);
    }
}
